Ext.define("TSUtilities",{singleton:!0,loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},loadWsapiRecordsWithParallelPages:function(a,b){var c=Ext.create("Deft.Deferred"),d=this,e=Ext.clone(a);return e.limit=1,e.pageSize=1,e.fetch=["ObjectID"],this.loadWsapiRecords(e,!0).then({success:function(e){a.pageSize=200,a.limit=a.pageSize;var f=e.resultSet.totalRecords,g=Math.ceil(f/a.pageSize),h=[];Ext.Array.each(_.range(1,g+1),function(c){var e=Ext.clone(a);e.currentPage=c,h.push(function(){var a=parseInt(100*c/g,10),f=b||"Loading values";return Rally.getApp().setLoading(f+" ("+a+"%)"),d.loadWsapiRecords(e)})}),CA.techservices.promise.ParallelThrottle.throttle(h,6,d).then({success:function(a){c.resolve(Ext.Array.flatten(a))},failure:function(a){c.reject(a)}})},failure:function(a){c.reject(a)}}),c.promise},getPreferenceProject:function(){var a=Rally.getApp();return a.getSetting("preferenceProjectRef")},isEditableProjectForCurrentUser:function(a,b){var c=b||Rally.getApp(),d=this;if(this.currentUserIsAdmin(b))return!0;var e=this._getOidFromRef(a),f=Ext.Array.filter(c.getContext().getPermissions().userPermissions,function(a){return"Editor"!=a.Role&&"ProjectAdmin"!=a.Role?!1:d._getOidFromRef(a._ref)==e});return console.log(f),f.length>0},getEditableProjectForCurrentUser:function(){var a=Rally.getApp();if(this._currentUserCanWrite())return a.getContext().getProjectRef();var b=this._getOidFromRef(a.getContext().getWorkspaceRef()),c=Ext.Array.filter(a.getContext().getPermissions().userPermissions,function(a){if(Ext.isEmpty(a.Workspace))return!1;var c=this._getOidFromRef(a.Workspace);return b!=c?!1:"Editor"==a.Role||"ProjectAdmin"==a.Role},this);return c.length>0?c[0]._ref:!1},_getOidFromRef:function(a){var b=a.replace(/\.js$/,"").split(/\//);return b[b.length-1].replace(/\.js/,"")},currentUserIsAdmin:function(a){var b=a||Rally.getApp();if(console.log("current user:",b.getContext().getUser()),this.currentUserIsSubAdmin())return!0;var c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),e=b.getContext().getWorkspace()._ref,f=!1;return d.length>0&&Ext.Array.each(d,function(a){e.replace(/\.js$/,"")==a._ref.replace(/\.js$/,"")&&(f=!0)}),f},currentUserIsSubAdmin:function(a){var b=a||Rally.getApp(),c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Subscription Admin"==a.Role});return d.length>0},_currentUserCanWrite:function(){var a=Rally.getApp();if(a.getContext().getUser().SubscriptionAdmin)return!0;var b=a.getContext().getPermissions().userPermissions,c=Ext.Array.filter(b,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),d=a.getContext().getWorkspace()._ref,e=!1;return c.length>0&&Ext.Array.each(c,function(a){d.replace(/\.js$/,"")==a._ref.replace(/\.js$/,"")&&(e=!0)}),e},_currentUserCanUnapprove:function(){return this.currentUserIsAdmin()}}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:Ext.String.format("Build date/time: {0} ({1})",APP_BUILD_DATE,BUILDER)})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),function(){"use strict";function a(a){var b=Highcharts.getOptions().colors;d(["M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11","M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9","M 3 0 L 3 10 M 8 0 L 8 10","M 0 3 L 10 3 M 0 8 L 10 8","M 0 3 L 5 3 L 5 0 M 5 10 L 5 7 L 10 7","M 3 3 L 8 3 L 8 8 L 3 8 Z","M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0","M 10 3 L 5 3 L 5 0 M 5 10 L 5 7 L 0 7","M 2 5 L 5 2 L 8 5 L 5 8 Z","M 0 0 L 5 10 L 10 0"],function(c,d){a.addPattern("highcharts-default-pattern-"+d,{path:c,color:b[d]})});var c={"diagonal-down":{path:"M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11",color:"black"},"diagonal-up":{path:"M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9",color:"black"},vertical:{path:"M 3 0 L 3 10 M 8 0 L 8 10",color:"black"},horizontal:{path:"M 0 3 L 10 3 M 0 8 L 10 8",color:"black"},circles:{path:"M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0",color:"white"},squares:{path:"M 3 3 L 8 3 L 8 8 L 3 8 Z",color:"black"},diamonds:{path:"M 0 0 L 5 10 L 10 0",color:"black"}};Ext.Object.each(c,function(b,c){a.addPattern(b,c)})}var b=0,c=Highcharts.wrap,d=Highcharts.each;Highcharts.SVGRenderer.prototype.addPattern=function(a,c){function e(a){j.rect(0,0,h,i).attr({fill:a}).add(f)}var f,g,h=c.width||10,i=c.height||10,j=this;return a||(a="highcharts-pattern-"+b,b+=1),f=this.createElement("pattern").attr({id:a,patternUnits:"userSpaceOnUse",width:c.width||10,height:c.height||10}).add(this.defs),f.id=f.element.id,c.path?(g=c.path,g.fill&&e(g.fill),this.createElement("path").attr({d:g.d||g,stroke:g.stroke||c.color||"#343434","stroke-width":g.strokeWidth||2}).add(f),f.color=c.color):c.image?this.image(c.image,0,0,c.width,c.height).add(f):c.color&&e(c.color),void 0!==c.opacity&&d(f.element.children,function(a){a.setAttribute("opacity",c.opacity)}),f},Highcharts.VMLElement&&(Highcharts.VMLRenderer.prototype.addPattern=function(a,c){var d;a||(a="highcharts-pattern-"+b,b+=1),d=this.patterns||{},d[a]=c,this.patterns=d},Highcharts.wrap(Highcharts.VMLRenderer.prototype.Element.prototype,"fillSetter",function(a,b,c,d){if("string"==typeof b&&"url(#"===b.substring(0,5)){var e,f=b.substring(5,b.length-1),g=this.renderer.patterns[f];g.image?(d.getElementsByTagName("fill").length&&d.removeChild(d.getElementsByTagName("fill")[0]),e=this.renderer.prepVML(["<",c,' type="tile" src="',g.image,'" />']),d.appendChild(document.createElement(e)),1===d.parentNode.nodeType&&(d.outerHTML=d.outerHTML)):g.color?a.call(this,g.color,c,d):a.call(this,"#A0A0A0",c,d)}else a.call(this,b,c,d)})),c(Highcharts.Chart.prototype,"getContainer",function(b){b.apply(this);var c=this,e=c.renderer,f=c.options,g=f.defs&&f.defs.patterns;a(e),g&&d(g,function(a){e.addPattern(a.id,a)})})}(),Ext.define("CA.apps.charts.Colors",{singleton:!0,grey4:"#C0C0C0",orange:"#FF8200",gold:"#F6A900",yellow:"#FAD200",lime:"#8DC63F",green_dk:"#1E7C00",blue_link:"#337EC6",blue:"#005EB8",blue_dark:"#00386e",blue_light:"#b2cee9",purple:"#7832A5",pink:"#DA1884",grey7:"#666",cumulativeFlowColors:function(){return[this.grey4,this.orange,this.gold,this.yellow,this.lime,this.green_dk,this.blue_link,this.blue,this.purple,this.pink]},burnLineColor:function(){return this.blue},burnColumnColor:function(){return this.lime},getConsistentBarColors:function(){return[this.grey4,this.blue_light,this.blue,this.blue_dark]},getConsistentBarPatterns:function(){return["url(#circles)","url(#diagonal-down)","url(#diagonal-up)","url(#vertical)","url(#horizontal)","url(#squares)","url(#diamonds)","url(#highcharts-default-pattern-6)","url(#highcharts-default-pattern-7)"]}}),Ext.define("CA.techservices.container.ChartWithDescription",{extend:"Ext.container.Container",alias:"widget.tschartwithdescription",layout:"hbox",items:[{xtype:"container",itemId:"chart_box",flex:1},{xtype:"container",itemId:"description_box"}],setDescription:function(a){var b=this.down("#description_box");b.removeAll(),Ext.isEmpty(a)||b.add({xtype:"panel",ui:"info-box",title:'<span class="icon-info-circle"> </span>',collapsible:!0,collapsed:!0,collapseDirection:"right",headerPosition:"left",width:375,height:375,margin:5,html:a})},setChart:function(a){var b=this.down("#chart_box");b.removeAll();var c=Ext.apply({xtype:"rallychart",loadMask:!1,chartColors:CA.apps.charts.Colors.getConsistentBarColors()},a);b.add(c)}}),Ext.define("CA.techservices.app.ChartApp",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},padding:5,description:"<em>No Description Available</em>",items:[{xtype:"container",width:"98%",items:[{xtype:"container",itemId:"banner_box",layout:"hbox",padding:10},{xtype:"tschartwithdescription"},{xtype:"container",itemId:"additional_display_box"}]}],config:{defaultSettings:{showPatterns:!1}},launch:function(){this.setDescription()},setDescription:function(){this.down("tschartwithdescription").setDescription(this.description)},clearBanner:function(){this.down("#banner_box").removeAll()},addToBanner:function(a){return this.down("#banner_box").add(a)},clearAdditionalDisplay:function(){this.down("#additional_display_box").removeAll()},addToAdditionalDisplay:function(a){return this.down("#additional_display_box").add(a)},setChart:function(a){return this.down("tschartwithdescription").setChart(a)},getDrillDownColumns:function(a){return[{dataIndex:"FormattedID",text:"id"},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"ScheduleState",text:"Schedule State"},{dataIndex:"PlanEstimate",text:"Plan Estimate"}]},showDrillDown:function(a,b){var c=Ext.create("Rally.data.custom.Store",{data:a,pageSize:2e3});Ext.create("Rally.ui.dialog.Dialog",{id:"detailPopup",title:b,width:Ext.getBody().getWidth()-50,height:Ext.getBody().getHeight()-50,closable:!0,layout:"border",items:[{xtype:"rallygrid",region:"center",layout:"fit",sortableColumns:!0,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:this.getDrillDownColumns(b),store:c}]}).show()},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),this.launch()},getSettingsFields:function(){return[{name:"showPatterns",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Patterns<br/><span style="color:#999999;"><i>Tick to use patterns in the chart instead of color.</i></span>'}]}}),Ext.define("TSDeliveryEfficiency",{extend:"CA.techservices.app.ChartApp",description:"<strong>Delivery Acceleration</strong><br/><br/>This chart displays the velocity and change in velocity for timeboxes that follow a selected timebox.  Use the toggle switch to choose the type of timebox (iteration or release), then use the dropdown to choose a baseline timebox.<p/>Click on a bar or point on the line to see a table with the accepted items from that timebox.<p/><ul><li>The line on the chart shows each timebox's velocity</li><li>The bars on the chart show the percentage difference from the baseline timebox.</li></ul>",integrationHeaders:{name:"TSDeliveryAcceleration"},config:{defaultSettings:{showPatterns:!1}},launch:function(){this.callParent(),this._addSelectors()},_addSelectors:function(){this.timebox_selector=null,this.timebox_type_selector=this.addToBanner({xtype:"tstogglebutton",toggleState:"iteration",itemId:"metric_selector",margin:"3 0 0 0",stateful:!0,stateId:"techservices-deliveryacceleration-timeboxtype-toggle",stateEvents:["change"],listeners:{scope:this,toggle:this._updateTimeboxSelector}}),this._updateTimeboxSelector()},_updateTimeboxSelector:function(){var a=this.timebox_type_selector.getValue();Ext.isEmpty(this.timebox_selector)||this.timebox_selector.destroy(),"iteration"==a?this.timebox_selector=this.addToBanner({xtype:"rallyiterationcombobox",fieldLabel:"Base Iteration:",labelWidth:80,margin:"0 0 10 25",stateful:!0,stateId:"techservices-deliveryacceleration-iteration-box",stateEvents:["change"],listeners:{scope:this,change:this._updateData}}):this.timebox_selector=this.addToBanner({xtype:"rallyreleasecombobox",fieldLabel:"Base Release:",labelWidth:75,margin:"0 0 10 25",stateful:!0,stateId:"techservices-deliveryacceleration-release-box",stateEvents:["change"],listeners:{scope:this,change:this._updateData}})},_updateData:function(){this.metric="size",Deft.Chain.pipeline([this._fetchTimeboxesAfterBaseline,this._fetchArtifactsInTimeboxes],this).then({scope:this,success:function(a){var b=this._collectArtifactsByTimebox(a||[]);this._makeChart(b)},failure:function(a){Ext.Msg.alert("--",a)}})},_fetchTimeboxesAfterBaseline:function(){var a=Ext.create("Deft.Deferred"),b=this.timebox_selector.getRecord().get("_ref"),c=this.timebox_type_selector.getValue(),d="StartDate",e="EndDate";"release"==c&&(d="ReleaseStartDate",e="ReleaseDate");var f=["ObjectID","Name",d,e];return this._getRecordByRef(b,f).then({scope:this,success:function(b){this.baseTimeboxObject=b;var g={model:c,limit:10,pageSize:10,fetch:f,context:{projectScopeUp:!1,projectScopeDown:!1},sorters:[{property:e,direction:"ASC"}],filters:[{property:d,operator:">=",value:b.get(d)},{property:e,operator:"<",value:Rally.util.DateTime.toIsoString(new Date)}]};TSUtilities.loadWsapiRecords(g).then({success:function(b){a.resolve(b)},failure:function(b){a.reject(b)}})},failure:function(b){a.reject(b)}}),a.promise},_fetchArtifactsInTimeboxes:function(a){if(0!==a.length){var b=this.timebox_type_selector.getValue(),c="StartDate",d="EndDate",e="Iteration";"release"==b&&(c="ReleaseStartDate",d="ReleaseDate",e="Release");var f=Ext.create("Deft.Deferred"),g=a[0].get(c),h=a[a.length-1].get(c),i=[{property:e+"."+c,operator:">=",value:g},{property:e+"."+c,operator:"<=",value:h},{property:"AcceptedDate",operator:"!=",value:null}],j={model:"HierarchicalRequirement",limit:1/0,filters:i,fetch:["FormattedID","Name","ScheduleState","Iteration","ObjectID","PlanEstimate","Release"]};return Deft.Chain.sequence([function(){return TSUtilities.loadWsapiRecords(j)},function(){return j.model="Defect",TSUtilities.loadWsapiRecords(j)},function(){return j.model="TestSet",TSUtilities.loadWsapiRecords(j)},function(){return j.model="DefectSuite",TSUtilities.loadWsapiRecords(j)}],this).then({success:function(a){f.resolve(Ext.Array.flatten(a))},failure:function(a){f.reject(a)}}),f.promise}},_collectArtifactsByTimebox:function(a){var b={},c=this.timebox_type_selector.getValue();if(0===a.length)return b;var d="Iteration";"release"==c&&(d="Release"),Ext.Array.each(a,function(a){var c=a.get(d).Name;Ext.isEmpty(b[c])&&(b[c]={items:[]}),b[c].items.push(a)}),Ext.Object.each(b,function(a,b){var c=b.items,d=Ext.Array.map(c,function(a){return a.get("PlanEstimate")||0});b.velocity=Ext.Array.sum(d)});var e=Ext.Object.getValues(b),f=e[0].velocity;return Ext.Object.each(b,function(a,b){var c=b.velocity||0,d=0;f>0&&(d=Math.round(100*(c-f)/f)),b.delta=d}),b},_makeChart:function(a){var b=this._getCategories(a),c=this._getSeries(a),d=CA.apps.charts.Colors.getConsistentBarColors();this.getSetting("showPatterns")&&(d=CA.apps.charts.Colors.getConsistentBarPatterns()),this.setChart({chartData:{series:c,categories:b},chartConfig:this._getChartConfig(),chartColors:d})},_getSeries:function(a){var b=[];return b.push({name:"Acceleration",data:this._getVelocityAcceleration(a),type:"column",yAxis:"b",tooltip:{valueSuffix:" %"}}),b.push({name:"Velocity",data:this._getVelocityData(a),type:"line",yAxis:"a"}),b},_getVelocityData:function(a){var b=this,c=[];return Ext.Object.each(a,function(a,d){c.push({y:d.velocity,_records:d.items,events:{click:function(){b.showDrillDown(this._records,a)}}})}),c},_getVelocityAcceleration:function(a){var b=this,c=[];return Ext.Object.each(a,function(a,d){c.push({y:d.delta,_records:d.items,events:{click:function(){b.showDrillDown(this._records,a)}}})}),c},_getCategories:function(a){return Ext.Object.getKeys(a)},_getChartConfig:function(){return{chart:{type:"column"},title:{text:"Delivery Acceleration"},xAxis:{},yAxis:[{id:"a",title:{text:"Velocity"}},{id:"b",title:{text:""},opposite:!0}],plotOptions:{column:{stacking:"normal"}},tooltip:{formatter:function(){return"Acceleration"==this.series.name?"<b>"+this.series.name+"</b>: "+this.point.y+"%":"<b>"+this.series.name+"</b>: "+Ext.util.Format.number(this.point.y,"0.##")}}}},_getRecordByRef:function(a,b){var c=Ext.create("Deft.Deferred"),d=a.split("/");if(d.length<2)return c.reject("NO NO NO"),c;var e=d.pop(),f=d.pop();return Rally.data.ModelFactory.getModel({type:f,success:function(a){a.load(e,{fetch:Ext.Array.merge(["ObjectID","Name"],b),callback:function(a,b){b.wasSuccessful()?c.resolve(a):c.reject(b.error.errors.join(". "))}})}}),c.promise},getSettingsFields:function(){return[{name:"showPatterns",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 25",boxLabel:'Show Patterns<br/><span style="color:#999999;"><i>Tick to use patterns in the chart instead of color.</i></span>'}]}});