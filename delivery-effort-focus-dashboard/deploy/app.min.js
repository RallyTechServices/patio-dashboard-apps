Ext.define("TSUtilities",{singleton:!0,loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},loadWsapiRecordsWithParallelPages:function(a,b){var c=Ext.create("Deft.Deferred"),d=this,e=Ext.clone(a);return e.limit=1,e.pageSize=1,e.fetch=["ObjectID"],this.loadWsapiRecords(e,!0).then({success:function(e){a.pageSize=200,a.limit=a.pageSize;var f=e.resultSet.totalRecords,g=Math.ceil(f/a.pageSize),h=[];Ext.Array.each(_.range(1,g+1),function(c){var e=Ext.clone(a);e.currentPage=c,h.push(function(){var a=parseInt(100*c/g,10),f=b||"Loading values";return Rally.getApp().setLoading(f+" ("+a+"%)"),d.loadWsapiRecords(e)})}),CA.techservices.promise.ParallelThrottle.throttle(h,6,d).then({success:function(a){c.resolve(Ext.Array.flatten(a))},failure:function(a){c.reject(a)}})},failure:function(a){c.reject(a)}}),c.promise},getPreferenceProject:function(){var a=Rally.getApp();return a.getSetting("preferenceProjectRef")},isEditableProjectForCurrentUser:function(a,b){var c=b||Rally.getApp(),d=this;if(this.currentUserIsAdmin(b))return!0;var e=this._getOidFromRef(a),f=Ext.Array.filter(c.getContext().getPermissions().userPermissions,function(a){return"Editor"!=a.Role&&"ProjectAdmin"!=a.Role?!1:d._getOidFromRef(a._ref)==e});return console.log(f),f.length>0},getEditableProjectForCurrentUser:function(){var a=Rally.getApp();if(this._currentUserCanWrite())return a.getContext().getProjectRef();var b=this._getOidFromRef(a.getContext().getWorkspaceRef()),c=Ext.Array.filter(a.getContext().getPermissions().userPermissions,function(a){if(Ext.isEmpty(a.Workspace))return!1;var c=this._getOidFromRef(a.Workspace);return b!=c?!1:"Editor"==a.Role||"ProjectAdmin"==a.Role},this);return c.length>0?c[0]._ref:!1},_getOidFromRef:function(a){var b=a.replace(/\.js$/,"").split(/\//);return b[b.length-1].replace(/\.js/,"")},currentUserIsAdmin:function(a){var b=a||Rally.getApp();if(console.log("current user:",b.getContext().getUser()),this.currentUserIsSubAdmin())return!0;var c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),e=b.getContext().getWorkspace()._ref,f=!1;return d.length>0&&Ext.Array.each(d,function(a){e.replace(/\.js$/,"")==a._ref.replace(/\.js$/,"")&&(f=!0)}),f},currentUserIsSubAdmin:function(a){var b=a||Rally.getApp(),c=b.getContext().getPermissions().userPermissions,d=Ext.Array.filter(c,function(a){return"Subscription Admin"==a.Role});return d.length>0},_currentUserCanWrite:function(){var a=Rally.getApp();if(a.getContext().getUser().SubscriptionAdmin)return!0;var b=a.getContext().getPermissions().userPermissions,c=Ext.Array.filter(b,function(a){return"Workspace Admin"==a.Role||"Subscription Admin"==a.Role}),d=a.getContext().getWorkspace()._ref,e=!1;return c.length>0&&Ext.Array.each(c,function(a){d.replace(/\.js$/,"")==a._ref.replace(/\.js$/,"")&&(e=!0)}),e},_currentUserCanUnapprove:function(){return this.currentUserIsAdmin()}}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:Ext.String.format("Build date/time: {0} ({1})",APP_BUILD_DATE,BUILDER)})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.util.Utilities",{singleton:!0,hashToArray:function(a){var b=[];for(var c in a)b.push(a[c]);return b},daysBetweenWithFraction:function(a,b,c){var d=Rally.technicalservices.util.Utilities.daysBetween(a,b,c);"string"==typeof a&&(a=Rally.util.DateTime.fromIsoString(a)),"string"==typeof b&&(b=Rally.util.DateTime.fromIsoString(b));var e=new Date(Ext.clone(b).setHours(0,0,0,0)),f=new Date(Ext.clone(a).setHours(0,0,0,0)),g=0,h=0;this.isWeekday(b)&&(g=Rally.util.DateTime.getDifference(b,e,"minute")),this.isWeekday(a)&&(h=Rally.util.DateTime.getDifference(a,f,"minute"));var i=1440*d+g-h;return i=i>0?Math.max(i/1440,.01):0,Number(i.toFixed(2))},daysBetween:function(a,b,c){"string"==typeof a&&(a=Rally.util.DateTime.fromIsoString(a)),"string"==typeof b&&(b=Rally.util.DateTime.fromIsoString(b));var d=Ext.clone(a).setHours(0,0,0,0),e=Ext.clone(b).setHours(0,0,0,0);if(d==e)return 1;if("number"==typeof d&&(d=new Date(d)),"number"==typeof e&&(e=new Date(e)),c){this.isWeekday(d)||(d=this.shiftDateToMonday(d)),this.isWeekday(e)||(e=this.shiftDateToMonday(e));var f,g,h=0;if(d>e){var i=e;e=d,d=i}var j=d.getDay(),k=e.getDay();return j=0==j?7:j,k=0==k?7:k,j>5&&k>5&&(h=1),j=j>5?5:j,k=k>5?5:k,f=Math.floor((e.getTime()-d.getTime())/6048e5),g=k>=j?5*f+(k-j):5*(f+1)-(j-k),g-=h,1>g&&(g=1),console.log(g,a,b),g}return Math.abs(Rally.util.DateTime.getDifference(d,e,"day"))},isWeekday:function(a){var b=!0,c=a.getDay();return(0===c||6===c)&&(b=!1),b},shiftDateToMonday:function(a){var b=a.getDay(),c=0;0===b&&(c=1),6===b&&(c=2);var d=a;return c>0&&(d=new Date(a.setHours(0)),d=Rally.util.DateTime.add(d,"day",c)),d},arrayOfDaysBetween:function(a,b,c,d){var e=[];if("string"==typeof a&&(a=Rally.util.DateTime.fromIsoString(a)),"string"==typeof b&&(b=Rally.util.DateTime.fromIsoString(b)),a>b){var f=b;b=a,a=f}var g=Ext.clone(a).setHours(0,0,0,0),h=Ext.clone(b).setHours(0,0,0,0),i=this.daysBetween(a,b,c),j=1,k="day";Ext.isNumber(d)&&i>d&&(j=7),2>=i&&(j=30,k="minute",h=Ext.clone(b).setHours(23,59,0,0));for(var l=new Date(g);h>=l;)(!c||this.isWeekday(l)||7===j||"minute"==k)&&e.push(l),l=Rally.util.DateTime.add(l,k,j);return e}}),function(){"use strict";function a(a){var b=Highcharts.getOptions().colors;d(["M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11","M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9","M 3 0 L 3 10 M 8 0 L 8 10","M 0 3 L 10 3 M 0 8 L 10 8","M 0 3 L 5 3 L 5 0 M 5 10 L 5 7 L 10 7","M 3 3 L 8 3 L 8 8 L 3 8 Z","M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0","M 10 3 L 5 3 L 5 0 M 5 10 L 5 7 L 0 7","M 2 5 L 5 2 L 8 5 L 5 8 Z","M 0 0 L 5 10 L 10 0"],function(c,d){a.addPattern("highcharts-default-pattern-"+d,{path:c,color:b[d]})});var c={"diagonal-down":{path:"M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11",color:"black"},"diagonal-up":{path:"M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9",color:"black"},vertical:{path:"M 3 0 L 3 10 M 8 0 L 8 10",color:"black"},horizontal:{path:"M 0 3 L 10 3 M 0 8 L 10 8",color:"black"},circles:{path:"M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0",color:"white"},squares:{path:"M 3 3 L 8 3 L 8 8 L 3 8 Z",color:"black"},diamonds:{path:"M 0 0 L 5 10 L 10 0",color:"black"}};Ext.Object.each(c,function(b,c){a.addPattern(b,c)})}var b=0,c=Highcharts.wrap,d=Highcharts.each;Highcharts.SVGRenderer.prototype.addPattern=function(a,c){function e(a){j.rect(0,0,h,i).attr({fill:a}).add(f)}var f,g,h=c.width||10,i=c.height||10,j=this;return a||(a="highcharts-pattern-"+b,b+=1),f=this.createElement("pattern").attr({id:a,patternUnits:"userSpaceOnUse",width:c.width||10,height:c.height||10}).add(this.defs),f.id=f.element.id,c.path?(g=c.path,g.fill&&e(g.fill),this.createElement("path").attr({d:g.d||g,stroke:g.stroke||c.color||"#343434","stroke-width":g.strokeWidth||2}).add(f),f.color=c.color):c.image?this.image(c.image,0,0,c.width,c.height).add(f):c.color&&e(c.color),void 0!==c.opacity&&d(f.element.children,function(a){a.setAttribute("opacity",c.opacity)}),f},Highcharts.VMLElement&&(Highcharts.VMLRenderer.prototype.addPattern=function(a,c){var d;a||(a="highcharts-pattern-"+b,b+=1),d=this.patterns||{},d[a]=c,this.patterns=d},Highcharts.wrap(Highcharts.VMLRenderer.prototype.Element.prototype,"fillSetter",function(a,b,c,d){if("string"==typeof b&&"url(#"===b.substring(0,5)){var e,f=b.substring(5,b.length-1),g=this.renderer.patterns[f];g.image?(d.getElementsByTagName("fill").length&&d.removeChild(d.getElementsByTagName("fill")[0]),e=this.renderer.prepVML(["<",c,' type="tile" src="',g.image,'" />']),d.appendChild(document.createElement(e)),1===d.parentNode.nodeType&&(d.outerHTML=d.outerHTML)):g.color?a.call(this,g.color,c,d):a.call(this,"#A0A0A0",c,d)}else a.call(this,b,c,d)})),c(Highcharts.Chart.prototype,"getContainer",function(b){b.apply(this);var c=this,e=c.renderer,f=c.options,g=f.defs&&f.defs.patterns;a(e),g&&d(g,function(a){e.addPattern(a.id,a)})})}(),Ext.define("CA.apps.charts.Colors",{singleton:!0,grey4:"#C0C0C0",orange:"#FF8200",gold:"#F6A900",yellow:"#FAD200",lime:"#8DC63F",green_dk:"#1E7C00",blue_link:"#337EC6",blue:"#005EB8",blue_dark:"#00386e",blue_light:"#b2cee9",purple:"#7832A5",pink:"#DA1884",grey7:"#666",cumulativeFlowColors:function(){return[this.grey4,this.orange,this.gold,this.yellow,this.lime,this.green_dk,this.blue_link,this.blue,this.purple,this.pink]},burnLineColor:function(){return this.blue},burnColumnColor:function(){return this.lime},getConsistentBarColors:function(){return[this.grey4,this.blue_light,this.blue,this.blue_dark]},getConsistentBarPatterns:function(){return["url(#circles)","url(#diagonal-down)","url(#diagonal-up)","url(#vertical)","url(#horizontal)","url(#squares)","url(#diamonds)","url(#highcharts-default-pattern-6)","url(#highcharts-default-pattern-7)"]}}),Ext.define("CA.techservices.container.ChartWithDescription",{extend:"Ext.container.Container",alias:"widget.tschartwithdescription",layout:"hbox",items:[{xtype:"container",itemId:"chart_box",flex:1},{xtype:"container",itemId:"description_box"}],setDescription:function(a){var b=this.down("#description_box");b.removeAll(),Ext.isEmpty(a)||b.add({xtype:"panel",ui:"info-box",title:'<span class="icon-info-circle"> </span>',collapsible:!0,collapsed:!0,collapseDirection:"right",headerPosition:"left",width:375,height:375,margin:5,overflowY:"auto",html:a})},setChart:function(a){var b=this.down("#chart_box");b.removeAll();var c=Ext.apply({xtype:"rallychart",loadMask:!1,chartColors:CA.apps.charts.Colors.getConsistentBarColors()},a);b.add(c)}}),Ext.define("CA.techservices.app.ChartApp",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},padding:5,description:"<em>Deprecated.  Make an array in this.descriptions instead.</em>",descriptions:[],items:[{xtype:"container",width:"98%",items:[{xtype:"container",itemId:"banner_box",layout:"hbox",padding:10},{xtype:"container",itemId:"main_display_box"},{xtype:"container",itemId:"additional_display_box"}]}],config:{defaultSettings:{showPatterns:!1}},launch:function(){var a=[this.description];!Ext.isEmpty(this.descriptions)&&this.descriptions.length>0&&(a=this.descriptions),console.log("descriptions",a),Ext.Array.each(a,function(a,b){console.log("index",b),this._addChartBox(b),this.applyDescription(a,b),this._addGridBox(b)},this)},_addChartBox:function(a){return this.down("#main_display_box").add({xtype:"tschartwithdescription",itemId:"main_chart_"+a})},_addGridBox:function(a){return this.down("#main_display_box").add({xtype:"tsgridbox",itemId:"main_grid_"+a})},setDescription:function(){this.applyDescription(this.description,0)},applyDescription:function(a,b){this.getChartBox(b).setDescription(a)},clearBanner:function(){this.down("#banner_box").removeAll()},addToBanner:function(a){return this.down("#banner_box").add(a)},clearAdditionalDisplay:function(){this.down("#additional_display_box").removeAll()},addToAdditionalDisplay:function(a){return this.down("#additional_display_box").add(a)},getChartBox:function(a){return Ext.isEmpty(a)&&(a=0),this.down("#main_chart_"+a)},setChart:function(a,b){this.getChartBox(b).setChart(a)},getGridBox:function(a){return Ext.isEmpty(a)&&(a=0),this.down("#main_grid_"+a)},setGrid:function(a,b){this.getGridBox(b).setGrid(a)},getDrillDownColumns:function(a){return[{dataIndex:"FormattedID",text:"id"},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"ScheduleState",text:"Schedule State"},{dataIndex:"PlanEstimate",text:"Plan Estimate"}]},showDrillDown:function(a,b){var c=Ext.create("Rally.data.custom.Store",{data:a,pageSize:2e3});Ext.create("Rally.ui.dialog.Dialog",{id:"detailPopup",title:b,width:Ext.getBody().getWidth()-50,height:Ext.getBody().getHeight()-50,closable:!0,layout:"border",items:[{xtype:"rallygrid",region:"center",layout:"fit",sortableColumns:!0,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:this.getDrillDownColumns(b),store:c}]}).show()},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},getSettingsFields:function(){return[{name:"showPatterns",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Patterns<br/><span style="color:#999999;"><i>Tick to use patterns in the chart instead of color.</i></span>'}]}}),Ext.define("CA.techservices.container.GridBox",{extend:"Ext.container.Container",alias:"widget.tsgridbox",items:[{xtype:"container",itemId:"grid_box"}],setGrid:function(a){var b=this.down("#grid_box");b.removeAll(),b.add(a)}}),Ext.define("TSDeliveryEffortFocus",{extend:"CA.techservices.app.ChartApp",description:"<strong>Delivery Effort Focus</strong><br/><br/>How is effort distributed within the team? This dashboard shows how many hours are being spent on accepted stories during sprints,  grouped by types assigned to the tasks.  (Your admin can choose a different field to define 'type' with the App Settings... menu option.)<p/>Click on a bar to see a table with the tasks from that type and timebox.<p/>The columns show a stacked count of actual hours by type on the tasks for tasks associated with stories accepted in the sprint.",integrationHeaders:{name:"TSDeliveryAcceleration"},config:{defaultSettings:{showPatterns:!1,typeField:"c_Type"}},launch:function(){return this.callParent(),Ext.isEmpty(this.getSetting("typeField"))?void Ext.Msg.alert("","Use the App Settings... menu option to choose a field to represent the type of task."):void this._getAllowedValues("Task",this.getSetting("typeField")).then({scope:this,success:function(a){this.allowed_types=a,this._updateData()},failure:function(a){Ext.Msg.alert("Problem loading allowed values",a)}})},_getAllowedValues:function(a,b){var c=Ext.create("Deft.Deferred");return this.logger.log("_getAllowedValues for",a,b),Rally.data.ModelFactory.getModel({type:a,success:function(a){return Ext.isEmpty(a.getField(b))?void c.reject("Please use the App Settings... menu option to choose a field to represent type of task."):void a.getField(b).getAllowedValueStore().load({callback:function(a,b,d){var e=Ext.Array.map(a,function(a){return a.get("StringValue")});c.resolve(e)}})},failure:function(a){c.reject("Error loading field values: "+a)}}),c},_updateData:function(){this.metric="size",this.timebox_type="Iteration",Deft.Chain.pipeline([this._fetchTimeboxes,this._sortIterations,this._fetchArtifactsInTimeboxes],this).then({scope:this,success:function(a){var b=this._collectArtifactsByTimebox(a||[]);this.clearAdditionalDisplay(),this._makeGrid(b),this._makeChart(b)},failure:function(a){Ext.Msg.alert("--",a)}})},_makeGrid:function(a){var b=this,c=[{dataIndex:"Name",text:"Story Type",flex:1}];Ext.Array.each(this._getCategories(a),function(a){c.push({dataIndex:b._getSafeIterationName(a)+"_number",text:a+"<br> Actuals Hours / %",align:"center",flex:1,renderer:function(a,b,c){return a.actual_hours_total+" / "+parseInt(100*a.actual_hours_pct,10)+"%"}})});var d=this._getGridRows(a),e=Ext.create("Rally.data.custom.Store",{data:d});this.addToAdditionalDisplay({xtype:"rallygrid",padding:5,margin:"10 0 0 0",showPagingToolbar:!1,enableEditing:!1,showRowActionsColumn:!1,store:e,columnCfgs:c})},_getGridRows:function(a){var b=this,c=this._getCategories(a),d=(this._getSeries(a),[]);return Ext.Array.each(this._getSeries(a),function(a){d.push({Type:"-None-"==a.name?"":a.name,Name:a.name})}),Ext.Array.each(d,function(a){Ext.Array.each(c,function(c){c=b._getSafeIterationName(c),a[c]=[],a[c+"_number"]=0})}),Ext.Array.each(d,function(c){var d=c.Type;Ext.Object.each(a,function(a,e){a=b._getSafeIterationName(a),c[a]=e.records[d];var f=e.records.all,g=0,h=0;Ext.Array.each(f,function(a){var b=a.get("Actuals")||0;h+=b}),Ext.Array.each(c[a],function(a){var b=a.get("Actuals")||0;g+=b});var i=h>0?g/h:0;c[a+"_number"]={actual_hours_total:g,actual_hours_pct:i}})}),d},_getSafeIterationName:function(a){return a.replace(/\./,"&#46;")},_fetchTimeboxes:function(){var a=(Ext.create("Deft.Deferred"),this.timebox_type);this.setLoading("Fetching timeboxes...");var b={model:a,limit:10,pageSize:10,fetch:["Name","StartDate","EndDate"],filters:[{property:"EndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(new Date)}],sorters:[{property:"EndDate",direction:"DESC"}],context:{projectScopeUp:!1,projectScopeDown:!1}};return TSUtilities.loadWsapiRecords(b)},_sortIterations:function(a){return Ext.Array.sort(a,function(a,b){return a.get("EndDate")<b.get("EndDate")?-1:a.get("EndDate")>b.get("EndDate")?1:0}),a},_fetchArtifactsInTimeboxes:function(a){if(0!==a.length){var b=this.timebox_type,c=this.getSetting("typeField"),d="StartDate",e="EndDate";"Release"==b&&(d="ReleaseStartDate",e="ReleaseDate");var f=Ext.create("Deft.Deferred"),g=a[0].get(d),h=a[a.length-1].get(d),i=[{property:b+"."+d,operator:">=",value:g},{property:b+"."+d,operator:"<=",value:h},{property:"WorkProduct.AcceptedDate",operator:"!=",value:null}],j={model:"Task",limit:1/0,filters:i,fetch:["FormattedID","Name","ScheduleState","Iteration","ObjectID","PlanEstimate","Project","Release",c,"Actuals","Estimate","ToDo","WorkProduct"]};return Deft.Chain.sequence([function(){return TSUtilities.loadWsapiRecords(j)}],this).then({success:function(a){f.resolve(Ext.Array.flatten(a))},failure:function(a){f.reject(a)}}),f.promise}},_collectArtifactsByTimebox:function(a){var b={},c=this.timebox_type,d=this.getSetting("typeField"),e=this.allowed_types;if(0===a.length)return b;var f={records:{all:[]}};return Ext.Array.each(e,function(a){f.records[a]=[]}),Ext.Array.each(a,function(a){var e=a.get(c).Name;Ext.isEmpty(b[e])&&(b[e]=Ext.Object.merge({},Ext.clone(f))),b[e].records.all.push(a);var g=a.get(d)||"";Ext.isEmpty(b[e].records[g])&&(b[e].records[g]=[]),b[e].records[g].push(a)}),b},_makeChart:function(a){var b=this._getCategories(a),c=this._getSeries(a),d=CA.apps.charts.Colors.getConsistentBarColors();this.getSetting("showPatterns")&&(d=CA.apps.charts.Colors.getConsistentBarPatterns()),this.setChart({chartData:{series:c,categories:b},chartConfig:this._getChartConfig(),chartColors:d}),this.setLoading(!1)},_getSeries:function(a){var b=[],c=this.allowed_types;return Ext.Array.each(c,function(c){var d=c;Ext.isEmpty(d)&&(d="-None-"),b.push({name:d,data:this._calculateMeasure(a,c),type:"column",stack:"a"})},this),b},_calculateMeasure:function(a,b){var c=this,d=[];return Ext.Object.each(a,function(a,e){var f=e.records[b]||[],g=Ext.Array.sum(Ext.Array.map(f,function(a){return a.get("Actuals")||0})),h=Ext.String.format("{0} ({1})",a,Ext.isEmpty(b)?"-- NONE --":b);d.push({y:g,_records:f,events:{click:function(){c.showDrillDown(this._records,h)}}})}),d},_getCategories:function(a){return Ext.Object.getKeys(a)},_getChartConfig:function(){return{chart:{type:"column"},title:{text:"Delivery Effort (Actual Task Hours by Type)"},xAxis:{},yAxis:[{title:{text:"Hours"}}],plotOptions:{column:{stacking:"normal"}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b>: "+Ext.util.Format.number(this.point.y,"0.##")}}}},getSettingsFields:function(){return[{name:"typeField",xtype:"rallyfieldcombobox",model:"Task",_isNotHidden:function(a){if(a.hidden)return!1;var b=a.attributeDefinition;return Ext.isEmpty(b)?!1:b.Constrained&&"STRING"==b.AttributeType}},{name:"showPatterns",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 25",boxLabel:'Show Patterns<br/><span style="color:#999999;"><i>Tick to use patterns in the chart instead of color.</i></span>'}]},getDrillDownColumns:function(a){var b=[{dataIndex:"FormattedID",text:"id",flex:1},{dataIndex:"Name",text:"Name",flex:3},{dataIndex:"WorkProduct",text:"Work Product",flex:1,renderer:function(a,b,c){return Ext.isEmpty(a)?"":a.FormattedID+": "+a.Name}},{dataIndex:"Estimate",text:"Task Hours (Est)"},{dataIndex:"Actuals",text:"Task Hours (Actual)"},{dataIndex:"Project",text:"Project",renderer:function(a){return a.Name},flex:1}];return/\(multiple\)/.test(a)&&b.push({dataIndex:"Name",text:"Count of Moves",renderer:function(a,b,c){return a.split("[Continued]").length}}),b}});